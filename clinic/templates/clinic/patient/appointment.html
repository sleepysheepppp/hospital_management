{% extends 'clinic/base.html' %}

{% block title %}预约挂号 - 门诊管理系统{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">预约挂号</h5>
            </div>
            <div class="card-body">
                {% if error %}
                    <div class="alert alert-danger">{{ error }}</div>
                {% endif %}
                {% if messages %}
                    {% for msg in messages %}
                        <div class="alert alert-success">{{ msg }}</div>
                    {% endfor %}
                {% endif %}

                <form method="post" action="{% url 'patient_appointment' %}">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label class="form-label">预约科室 <span class="text-danger">*</span></label>
                        {{ form.dept }}
                        {% if form.dept.errors %}
                            <small class="text-danger">{{ form.dept.errors.0 }}</small>
                        {% endif %}
                    </div>
                    <div class="mb-3">
                        <label class="form-label">预计到达时间 <span class="text-danger">*</span></label>
                        <!-- 修复：强制指定datetime-local的格式，适配Django解析 -->
                        {{ form.arrival_time }}
                        <!-- 新增：手动设置value格式（如果表单回显） -->
                        {% if form.arrival_time.value %}
                            <script>
                                // 将Python datetime转换为前端兼容的格式（YYYY-MM-DDTHH:MM）
                                const dt = new Date("{{ form.arrival_time.value|date:'Y-m-d H:i' }}");
                                const localDt = dt.toISOString().slice(0, 16);
                                document.querySelector('input[type="datetime-local"]').value = localDt;
                            </script>
                        {% endif %}
                        <div class="form-text">最多可预约未来7天的号源，且不能早于当前时间（格式：YYYY-MM-DD HH:MM）</div>
                        {% if form.arrival_time.errors %}
                            <small class="text-danger">{{ form.arrival_time.errors.0 }}</small>
                        {% endif %}
                    </div>
                    <button type="submit" class="btn btn-primary w-100">提交预约</button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}